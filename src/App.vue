<template>
  <div>
    <div class = 'wrapper'>
      PWA 로 작성한 vue3 페이지입니다. (5초로수정)
      <button class="btn-large" @click.stop="onAllowNotification"> 알림 허용 </button>
      <button class="btn-large" @click.stop="onFingerPrint"> 인식 </button>
      <div>
         {{ state.keyStr }}
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import { defineComponent, onMounted, reactive } from 'vue';

// import HelloWorld from './components/HelloWorld.vue';

export default defineComponent({
  name: 'App',
  components: {
    
  },
  setup() {

    const state = reactive({
      keyStr: "",
    })
    const initWebPushWorker = () => {
      
    } 

    const onFingerPrint = () => {
      if (!window.PublicKeyCredential) {
        /* Client not capable. Handle error. */
      }

      const publicKey: any = {
        // The challenge is produced by the server; see the Security Considerations
        challenge: new Uint8Array([
          21,
          31,
          105 /* 29 more random bytes generated by the server */
        ]),

        // Relying Party:
        rp: {
          name: "ACME Corporation"
        },

        // User:
        user: {
          id: Uint8Array.from(
            window.atob("MIIBkzCCATigAwIBAjCCAZMwggE4oAMCAQIwggGTMII="),
            c => c.charCodeAt(0)
          ),
          name: "mynet81@gmail.com",
          displayName: "Alex P. Müller"
        },

        // This Relying Party will accept either an ES256 or RS256 credential, but
        // prefers an ES256 credential.
        pubKeyCredParams: [
          {
            type: "public-key",
            alg: -7 // "ES256" as registered in the IANA COSE Algorithms registry
          },
          {
            type: "public-key",
            alg: -257 // Value registered by this specification for "RS256"
          }
        ],

        authenticatorSelection: {
          // Try to use UV if possible. This is also the default.
          userVerification: "preferred"
        },

        timeout: 360000, // 6 minutes
        excludeCredentials: [], // No exclude list of PKCredDescriptors
        extensions: { loc: true } // Include location information
        // in attestation
      };

      // Note: The following call will cause the authenticator to display UI.
      navigator.credentials
        .create({ publicKey })
        // eslint-disable-next-line no-unused-vars
        .then((newCredentialInfo: any) => {
          // Send new credential info to server for verification and registration.
          // eslint-disable-next-line no-unused-vars, no-undef
          
          // eslint-disable-next-line no-undef
          console.log("save", newCredentialInfo);
          state.keyStr = newCredentialInfo;
        })
        .catch(() => {
          // No acceptable authenticator or user refused consent. Handle appropriately.

          console.log("fail");
          state.keyStr = " Fail";
        });
    }

    const onAllowNotification = () => {
      Notification.requestPermission().then((result) => {
        if (result === "granted") {
          randomNotification();
        }
      });
    }

    const randomNotification = () => {
      const notifTitle = "알림";
      const options = {
        body: "안녕하세요 Notification Test "
      };
      new Notification(notifTitle, options);
      setTimeout(randomNotification, 5000);
    }

    onMounted(() => {
      initWebPushWorker();
    })

    return {
      onFingerPrint,
      onAllowNotification,
      state
    }
  }
});
</script>

<style>
.wrapper {
  display: flex;
  flex-direction: column;
  width : 100%;
  height: 100%;
  align-items: center;
  justify-content: center;
}
.btn-large {
  width: 200px;
  height: 50px;
  border-radius: 10px;
  cursor: pointer;
  margin-top:4rem;
}
#app {
  font-family: Avenir, Helvetica, Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-align: center;
  color: #2c3e50;
  margin-top: 50px;
}
</style>
